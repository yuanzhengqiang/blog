# <center>词法环境</center>

> ECMAScript规范中对词法环境的描述如下：词法环境是用来定义 基于词法嵌套结构的ECMAScript代码内的标识符与变量值和函数值之间的关联关系 的一种规范类型。一个词法环境由环境记录（Environment Record）和一个可能为null的对外部词法环境的引用（outer）组成。一般来说，词法环境都与特定的ECMAScript代码语法结构相关联，例如函数、代码块、TryCatch中的Catch从句，并且每次执行这类代码时都会创建新的词法环境

简言之，**词法环境**就是相应代码块内**标识符与值的关联关系**的体现。

它由 **环境记录（Environment Record）** 和 **对外部词法环境的引用（outer）** 组成。

 - 环境记录（Environment Record）：记录相应代码块的标识符绑定。
	
 - 对外部词法环境的引用（outer）：用于形成多个词法环境在逻辑上的嵌套结构，以实现可以访问外部词法环境变量的能力。

 
 ## 环境记录
 
 **环境记录**大体分三类:
 
 - 声明式环境记录（Declarative Environment Record）
 - 对象式环境记录（Object Environment Record）
 - 全局环境记录（Global Environment Record）

### 声明式环境记录（Declarative Environment Record）

**声明式环境记录** 是用来定义那些直接将标识符与语言值绑定的ES语法元素，例如变量，常量，`let，class，module，import`以及函数声明等。

声明式环境记录 又有两种特殊类型:

- 函数环境记录（Function Environment Record）
- 模块环境记录（Module Environment Record）

	**函数环境记录** 用于体现一个函数的顶级作用域，如果函数不是箭头函数，还会提供一个this的绑定。
	
	**模块环境记录** 用于体现一个模块的外部作用域（即模块export所在环境），除了正常绑定外，也提供了所有引入的其他模块的绑定（即import的所有模块，这些绑定只读），因此我们可以直接访问引入的模块。


### 对象式环境记录（Object Environment Record）

每个对象式环境记录都与一个对象相关联，这个对象叫做对象式环境记录的 `binding object`。可以理解为对象式环境记录就是基于这个 `binding object`，以对象属性的形式进行标识符绑定，标识符与 `binding object` 的属性名一一对应。

是对象就可以动态添加或者删除属性，所以对象环境记录不存在不可变绑定。

对象式环境记录用来定义那些将标识符与某些对象属性相绑定的ES语法元素，例如`with`语句、全局`var`声明和函数声明。


### 全局环境记录（Global Environment Record）

全局环境记录逻辑上来说是单个记录，但是实际上可以看作是对一个对象式环境记录组件和一个声明式环境记录组件的封装。

之前说过每个对象式环境记录都有一个`binding object`，全局环境记录的对象式环境记录的`binding object`就是全局对象，在浏览器内，全局的`this`及`window`绑定都指向全局对象。

全局环境记录的对象式环境记录组件，绑定了所有内置全局属性、全局的函数声明以及全局的var声明。

所以这些绑定我们可以通过`window.xx`或`this.xx`获取到。



全局代码的其他声明（如`let、const、class`等）则绑定在声明式环境记录组件内，由于声明式环境记录组件并不是基于简单的对象形式来实现绑定，所以这些声明我们并`不能通过全局对象的属性来访问`。


## 外部词法环境的引用（outer）

**外部词法环境的引用** 是将一个词法环境和其外部词法环境链接起来，外部词法环境又拥有对其自身的外部词法环境的引用。这样就形成一个链式结构，这里我们称其为**环境链**（即ES6之前的作用域链），全局环境是这条链的顶端。

注意:

1. 全局环境的外部词法环境引用为null
2. 一个词法环境可以作为多个词法环境的外部环境。例如全局声明了多个函数，则这些函数词法环境的外部词法环境引用都指向全局环境。


**环境链**的存在是为了标识符的解析，通俗的说就是查找变量。首先在当前环境查找变量，找不到就去外部环境找，还找不到就去外部环境的外部环境找，以此类推，直到找到，或者到环境链顶端（全局环境）还未找到则抛出`ReferenceError`。

**标识符解析**：在环境链中解析变量（绑定）的过程









